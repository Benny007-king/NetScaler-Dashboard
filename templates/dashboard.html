<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NetScaler Dashboard ‚Äî Ultimate</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            dark: { 900: '#0f172a', 800: '#1e293b' }
          }
        }
      }
    }
  </script>
  <style>
    body {
      background: radial-gradient(circle at top center, #1e293b 0%, #020617 100%);
      min-height: 100vh;
      color: #e2e8f0;
    }
    .glass-panel {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    /* Scrollbars */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    /* Tables */
    .table-container { overflow-x: auto; border-radius: 0.75rem; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    th {
      background: rgba(15, 23, 42, 0.95);
      color: #94a3b8; font-weight: 600; text-transform: uppercase; font-size: 0.75rem;
      padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); white-space: nowrap;
    }
    td { padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.875rem; }
    tr:last-child td { border-bottom: none; }
    tbody tr:hover td { background: rgba(59, 130, 246, 0.05); }

    /* Badges */
    .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; line-height: 1; border: 1px solid transparent; }
    .badge-success { background: rgba(16, 185, 129, 0.15); color: #34d399; border-color: rgba(16, 185, 129, 0.2); }
    .badge-danger { background: rgba(239, 68, 68, 0.15); color: #f87171; border-color: rgba(239, 68, 68, 0.2); }
    .badge-warning { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border-color: rgba(245, 158, 11, 0.2); }
    
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Tabs */
    .tab-btn { position: relative; transition: all 0.2s; cursor: pointer; }
    .tab-btn.active { color: #60a5fa; background: rgba(59, 130, 246, 0.1); }
    .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: #60a5fa; box-shadow: 0 -2px 10px rgba(96, 165, 250, 0.5); }

    /* Date Picker Overrides */
    .dp { background: #1e293b !important; border: 1px solid #334155 !important; border-radius: 0.75rem !important; color: white !important; }
    .dp .day:hover { background: #334155 !important; }
    .dp .day.selected { background: #3b82f6 !important; }
    
    /* Charts */
    .chart-wrapper { position: relative; height: 160px; width: 100%; display:flex; justify-content:center; }
    .chart-wrapper-line { position: relative; height: 160px; width: 100%; }
  </style>
</head>
<body class="p-4 md:p-8">

<header class="glass-panel rounded-2xl mb-6 p-4 flex flex-col md:flex-row items-center justify-between sticky top-4 z-50 fade-in">
  <div class="flex items-center gap-4 mb-4 md:mb-0">
    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
    </div>
    <div>
        <h1 class="text-xl font-bold tracking-tight text-white">NetScaler Dashboard</h1>
        <p class="text-xs text-blue-400 font-mono">Live Monitoring</p>
    </div>
  </div>

  <div class="flex items-center gap-3 bg-slate-900/50 p-1.5 rounded-xl border border-white/5">
    <label class="text-sm text-slate-400 pl-2">Node:</label>
    <select id="nodeSelect" onchange="changeNode(this.value)" class="bg-slate-800 text-white text-sm border-none rounded-lg focus:ring-2 focus:ring-blue-500 py-1.5 px-3 cursor-pointer hover:bg-slate-700 transition-colors">
      <option value="primary">Primary</option>
      <option value="secondary">Secondary</option>
    </select>
    <button id="refreshBtn" type="button" onclick="forceRefresh()" class="bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-lg transition-all shadow-lg active:scale-95">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
    </button>
    <a href="/logout" class="bg-red-500/10 hover:bg-red-500/20 text-red-400 p-2 rounded-lg transition-all border border-red-500/20" title="Logout">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
    </a>
  </div>
</header>

<main class="max-w-7xl mx-auto">
  
  <div id="capsLine" class="mb-6 text-sm text-slate-400 font-mono bg-slate-900/40 p-3 rounded-lg border border-dashed border-slate-700 flex items-center gap-2">
    <svg class="w-4 h-4 text-slate-500 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
    Detecting system capabilities...
  </div>

  <div class="tabs flex space-x-1 mb-6 border-b border-slate-700/50" role="tablist">
    <button onclick="setActiveTab('overview')" class="tab-btn px-6 py-3 text-sm font-medium text-slate-400 hover:text-white rounded-t-lg active" data-tab="overview">Overview</button>
    <button onclick="setActiveTab('applications')" class="tab-btn px-6 py-3 text-sm font-medium text-slate-400 hover:text-white rounded-t-lg" data-tab="applications">Applications</button>
    <button onclick="setActiveTab('failover')" class="tab-btn px-6 py-3 text-sm font-medium text-slate-400 hover:text-white rounded-t-lg" data-tab="failover">Failover</button>
    <button onclick="setActiveTab('sessions')" class="tab-btn px-6 py-3 text-sm font-medium text-slate-400 hover:text-white rounded-t-lg" data-tab="sessions">Sessions</button>
    <button onclick="setActiveTab('unlock')" class="tab-btn px-6 py-3 text-sm font-medium text-slate-400 hover:text-white rounded-t-lg" data-tab="unlock">Unlock User</button>
  </div>

  <section class="panel fade-in" id="panel-overview">
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div class="glass-panel rounded-2xl p-4 flex flex-col items-center">
        <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">CPU Usage</h3>
        <div class="chart-wrapper">
          <canvas id="chartCpu"></canvas>
        </div>
        <div class="mt-2 text-2xl font-bold text-white font-mono" id="valCpu">--%</div>
      </div>
      
      <div class="glass-panel rounded-2xl p-4 flex flex-col items-center">
        <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Memory Usage</h3>
        <div class="chart-wrapper">
          <canvas id="chartMem"></canvas>
        </div>
        <div class="mt-2 text-2xl font-bold text-white font-mono" id="valMem">--%</div>
      </div>

      <div class="glass-panel rounded-2xl p-4 flex flex-col items-center w-full">
        <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">HTTP Traffic (Live)</h3>
        <div class="chart-wrapper-line">
          <canvas id="chartHttp"></canvas>
        </div>
        <div class="mt-2 text-xl font-bold text-blue-400 font-mono" id="valHttp">0 req/s</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="glass-panel rounded-2xl p-6">
        <h3 class="text-lg font-semibold text-white mb-4">Node Statistics</h3>
        <div id="sysStats" class="table-container text-sm">Loading...</div>
      </div>

      <div class="glass-panel rounded-2xl p-6">
        <h3 class="text-lg font-semibold text-white mb-4">High Availability</h3>
        <div id="haStatus" class="table-container text-sm">Loading...</div>
      </div>
    </div>
  </section>

  <section class="panel hidden fade-in" id="panel-applications">
    <div id="appsNotice" class="mb-4 text-xs text-amber-400 bg-amber-400/10 p-3 rounded border border-amber-400/20 hidden"></div>
    
    <div class="glass-panel rounded-2xl p-0 overflow-hidden mb-8">
      <div class="p-4 border-b border-white/5 bg-white/5 flex justify-between items-center">
        <h3 class="font-semibold text-white">Applications</h3>
        <div class="badge badge-warning" id="appsModeChip">Mode: <span id="appsMode">...</span></div>
      </div>
      <div class="table-container p-2">
        <table>
          <thead><tr><th class="w-12">#</th><th>Name</th><th>VIP</th><th>Port</th><th>Status</th></tr></thead>
          <tbody id="appsTable" class="text-slate-300"><tr><td colspan="5" class="text-center py-8 text-slate-500">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="glass-panel rounded-2xl p-0 overflow-hidden">
      <div class="p-4 border-b border-white/5 bg-white/5"><h3 class="font-semibold text-white">Services</h3></div>
      <div class="table-container p-2">
        <table>
          <thead><tr><th class="w-12">#</th><th>Type</th><th>Name</th><th>IP</th><th>Port</th><th>Status</th><th>Members</th></tr></thead>
          <tbody id="svcTable" class="text-slate-300"><tr><td colspan="7" class="text-center py-8 text-slate-500">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="panel hidden fade-in" id="panel-failover">
    <div class="glass-panel rounded-2xl p-6">
      <div class="flex flex-wrap gap-4 mb-6 p-4 bg-slate-900/50 rounded-xl border border-slate-700/50 items-end">
        <div class="grid gap-1">
          <label class="text-xs text-slate-400 ml-1">From</label>
          <div class="dp-wrap relative flex items-center">
            <input id="failFrom" type="hidden" />
            <input id="failFromDisplay" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-l-lg py-2 px-3 w-40" readonly />
            <button id="failFromBtn" class="bg-slate-700 hover:bg-slate-600 border-slate-700 rounded-r-lg px-3 py-2 text-slate-300">üìÖ</button>
          </div>
        </div>
        <div class="grid gap-1">
          <label class="text-xs text-slate-400 ml-1">To</label>
          <div class="dp-wrap relative flex items-center">
            <input id="failTo" type="hidden" />
            <input id="failToDisplay" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-l-lg py-2 px-3 w-40" readonly />
            <button id="failToBtn" class="bg-slate-700 hover:bg-slate-600 border-slate-700 rounded-r-lg px-3 py-2 text-slate-300">üìÖ</button>
          </div>
        </div>
        <div class="grid gap-1">
            <label class="text-xs text-slate-400 ml-1">Type</label>
            <select id="failType" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg py-2 px-3">
              <option value="">All</option><option value="automatic">Automatic</option><option value="manual">Manual</option><option value="failure">Failure</option><option value="role-change">Role Change</option>
            </select>
        </div>
        <div class="flex gap-2 ml-auto">
            <button id="failSearch" onclick="loadFailover()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-lg font-medium">Search</button>
            <button id="failExport" onclick="window.open('/api/export/failover-history')" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-4 py-2 rounded-lg border border-slate-600">CSV</button>
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead><tr><th class="w-12">#</th><th>Timestamp</th><th>Event Type</th><th>Reason</th><th>Role Change</th></tr></thead>
          <tbody id="failTable" class="text-slate-300"><tr><td colspan="5" class="text-center py-8 text-slate-500">Set filters and click Search...</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="panel hidden fade-in" id="panel-sessions">
    <div class="glass-panel rounded-2xl p-6">
      <div class="flex flex-wrap gap-4 mb-6 p-4 bg-slate-900/50 rounded-xl border border-slate-700/50 items-end">
        <div class="flex gap-2">
            <div class="grid gap-1">
                <label class="text-xs text-slate-400 ml-1">From</label>
                <div class="dp-wrap relative flex items-center">
                    <input id="sessFrom" type="hidden" /><input id="sessFromDisplay" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-l-lg py-2 px-2 w-32" readonly /><button id="sessFromBtn" class="bg-slate-700 border-slate-700 rounded-r-lg px-2 py-2 text-slate-300">üìÖ</button>
                </div>
            </div>
            <div class="grid gap-1">
                <label class="text-xs text-slate-400 ml-1">To</label>
                <div class="dp-wrap relative flex items-center">
                    <input id="sessTo" type="hidden" /><input id="sessToDisplay" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-l-lg py-2 px-2 w-32" readonly /><button id="sessToBtn" class="bg-slate-700 border-slate-700 rounded-r-lg px-2 py-2 text-slate-300">üìÖ</button>
                </div>
            </div>
        </div>
        <div class="grid gap-1 flex-grow">
            <label class="text-xs text-slate-400 ml-1">User</label>
            <input id="sessUser" type="text" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg py-2 px-3 w-full" placeholder="user@domain" />
        </div>
        <div class="grid gap-1">
            <label class="text-xs text-slate-400 ml-1">Type</label>
            <select id="sessType" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg py-2 px-3"><option value="">All</option><option value="web">Web</option><option value="vpn">VPN</option></select>
        </div>
        <div class="grid gap-1">
            <label class="text-xs text-slate-400 ml-1">Status</label>
            <select id="sessStatus" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg py-2 px-3"><option value="">All</option><option value="active">Active</option><option value="terminated">Terminated</option></select>
        </div>
        <div class="flex gap-2">
            <button id="sessSearch" onclick="loadSessions()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-lg font-medium">Search</button>
            <button id="sessExport" onclick="window.open('/api/export/user-sessions')" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-4 py-2 rounded-lg border border-slate-600">CSV</button>
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead><tr><th class="w-12">#</th><th>User</th><th>Type</th><th>Status</th><th>Duration</th><th>IP</th><th>Node</th><th>Start</th></tr></thead>
          <tbody id="sessTable" class="text-slate-300"><tr><td colspan="8" class="text-center py-8 text-slate-500">Set filters and click Search...</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="panel hidden fade-in" id="panel-unlock">
    <div class="max-w-xl mx-auto glass-panel rounded-2xl p-8 border-t-4 border-blue-500">
      <h3 class="text-2xl font-bold text-white text-center mb-6">Unlock User Account</h3>
      <div class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-1">
                <label class="block text-sm font-medium text-slate-400 mb-2">Node</label>
                <select id="unlockNode" class="w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3"><option value="primary">Primary</option><option value="secondary">Secondary</option></select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-slate-400 mb-2">Username</label>
                <input id="unlockUsername" type="text" class="w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3" placeholder="e.g. jdoe" />
            </div>
        </div>
        <button id="unlockBtn" onclick="doUnlock()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all">Unlock Account</button>
        <div id="unlockMsg" class="min-h-[40px] flex items-center justify-center text-sm font-medium"></div>
      </div>
    </div>
  </section>

</main>

<div id="datePicker" class="dp hidden absolute z-50 p-4 shadow-2xl w-80" role="dialog" aria-modal="true">
  <div class="dp-header flex justify-between items-center mb-4">
    <button id="dpPrev" class="hover:bg-slate-700 p-1 rounded">‚Äπ</button>
    <div class="dp-title font-bold text-white" id="dpTitle">Month YYYY</div>
    <button id="dpNext" class="hover:bg-slate-700 p-1 rounded">‚Ä∫</button>
  </div>
  <div class="cal-grid grid grid-cols-7 gap-1 text-center text-sm mb-4" id="dpGrid"></div>
  <div class="dp-quick flex gap-2 mb-4 justify-center">
    <button data-range="24h" class="bg-slate-700 hover:bg-slate-600 text-xs px-2 py-1 rounded">24h</button>
    <button data-range="7d" class="bg-slate-700 hover:bg-slate-600 text-xs px-2 py-1 rounded">7d</button>
    <button data-range="today" class="bg-slate-700 hover:bg-slate-600 text-xs px-2 py-1 rounded">Today</button>
    <button data-clear="1" class="bg-slate-700 hover:bg-slate-600 text-xs px-2 py-1 rounded">Clear</button>
  </div>
  <div class="dp-footer flex justify-between items-center pt-3 border-t border-slate-700">
    <div class="time flex items-center gap-1 text-xs">
      <span class="text-slate-400">Time</span><select id="dpHour" class="bg-slate-800 rounded p-1"></select>:<select id="dpMin" class="bg-slate-800 rounded p-1"></select>
    </div>
    <div class="flex gap-2">
      <button id="dpCancel" class="text-xs text-slate-400 hover:text-white px-2">Cancel</button>
      <button id="dpApply" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded">Apply</button>
    </div>
  </div>
</div>

<script>
// --- GLOBAL VARS ---
const state = { node: 'primary', apiModes: {}, interval: null, refreshMs: 5000 };
let cpuChart, memChart, httpChart;
const httpHistory = { labels: [], data: [] };

// --- HELPER FUNCTIONS ---
function $(id) { return document.getElementById(id); }
function qs(params) {
    return Object.entries(params)
        .filter(([_,v])=>v!==undefined&&v!==null&&v!=='')
        .map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
        .join('&');
}
function escapeHtml(s) {
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}

// --- API WRAPPER ---
async function getJSON(url, opts) {
    try {
        const res = await fetch(url, { headers: { 'Accept': 'application/json' }, ...(opts || {}) });
        const text = await res.text();
        return { ok: res.ok, status: res.status, data: text ? JSON.parse(text) : {} };
    } catch (e) {
        return { ok: false, data: { raw: String(e) } };
    }
}

// --- TABS LOGIC (FIXED) ---
function setActiveTab(name) {
    // Hide all panels
    const panels = document.querySelectorAll('section.panel');
    panels.forEach(p => p.classList.add('hidden'));
    
    // Show selected panel
    const selected = document.getElementById(`panel-${name}`);
    if(selected) selected.classList.remove('hidden');

    // Update buttons
    const btns = document.querySelectorAll('.tab-btn');
    btns.forEach(b => {
        if(b.dataset.tab === name) b.classList.add('active');
        else b.classList.remove('active');
    });

    // Trigger data load
    if (name === 'overview') loadOverview();
    if (name === 'applications') { loadApplications(); loadServices(); }
    if (name === 'failover') loadFailover();
    if (name === 'sessions') loadSessions();
    
    // Restart interval to focus on this tab
    startAutoRefresh();
}

function changeNode(val) {
    state.node = val;
    const currentTab = document.querySelector('.tab-btn.active').dataset.tab;
    updateAppsTabAvailability();
    setActiveTab(currentTab);
}

function forceRefresh() {
    const btn = $('refreshBtn');
    btn.classList.add('animate-spin'); // Add visual feedback
    const currentTab = document.querySelector('.tab-btn.active').dataset.tab;
    
    // Trigger load
    setActiveTab(currentTab);
    fetchCaps();
    
    setTimeout(() => btn.classList.remove('animate-spin'), 1000);
}

// --- CHART INIT ---
function initCharts() {
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = '#334155';
    
    try {
        cpuChart = new Chart($('chartCpu'), {
            type: 'doughnut', 
            data: { labels: ['Used', 'Free'], datasets: [{ data: [0, 100], backgroundColor: ['#3b82f6', '#1e293b'], borderWidth: 0, cutout: '75%' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
        });
        
        memChart = new Chart($('chartMem'), {
            type: 'doughnut',
            data: { labels: ['Used', 'Free'], datasets: [{ data: [0, 100], backgroundColor: ['#8b5cf6', '#1e293b'], borderWidth: 0, cutout: '75%' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
        });
        
        httpChart = new Chart($('chartHttp'), {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { beginAtZero: true, grid: { borderDash: [5, 5] } } },
                animation: { duration: 0 }
            }
        });
    } catch(e) { console.error("Chart init failed", e); }
}

// --- DATA LOADERS ---
async function fetchCaps() {
    const r = await getJSON('/api/caps');
    if (r.ok) {
        state.apiModes = r.data.api_mode || {};
        const p = (state.apiModes.primary || 'nitro').toUpperCase();
        const s = (state.apiModes.secondary || 'nitro').toUpperCase();
        $('capsLine').innerHTML = `Capabilities: <span class="text-blue-400 font-bold mx-1">PRI: ${p}</span> | <span class="text-blue-400 font-bold mx-1">SEC: ${s}</span>`;
        updateAppsTabAvailability();
    }
}

function updateAppsTabAvailability() {
    const mode = state.apiModes[state.node] || 'nitro';
    $('appsMode').textContent = mode.toUpperCase();
    const note = $('appsNotice');
    if (mode === 'nextgen') {
        note.classList.add('hidden');
    } else {
        note.classList.remove('hidden');
        note.innerHTML = '‚ö†Ô∏è <strong>Nitro Mode:</strong> Showing LB vServers as Applications (fallback).';
    }
}

async function loadOverview() {
    const r = await getJSON(`/api/system-stats?node=${state.node}`);
    const ha = await getJSON(`/api/ha-status`);

    if (r.ok) {
        const d = r.data.ns_stats?.ns || r.data.ns_stats || {};
        let cpu = parseFloat(d.cpuusagepcnt || d.cpuusage || 0);
        let mem = parseFloat(d.memusagepcnt || d.memusagepct || 0);
        let http = parseFloat(d.httprequestsrate || 0);

        if (cpuChart) { cpuChart.data.datasets[0].data = [cpu, 100 - cpu]; cpuChart.update(); $('valCpu').innerText = cpu.toFixed(1) + '%'; }
        if (memChart) { memChart.data.datasets[0].data = [mem, 100 - mem]; memChart.update(); $('valMem').innerText = mem.toFixed(1) + '%'; }
        if (httpChart) {
            const now = new Date().toLocaleTimeString();
            if (httpHistory.labels.length > 20) { httpHistory.labels.shift(); httpHistory.data.shift(); }
            httpHistory.labels.push(now); httpHistory.data.push(http);
            httpChart.data.labels = httpHistory.labels; httpChart.data.datasets[0].data = httpHistory.data; httpChart.update();
            $('valHttp').innerText = Math.round(http) + ' req/s';
        }

        const role = r.data.ha_role || '';
        const badge = role.toUpperCase().includes('PRIMARY') ? 'badge-success' : 'badge-warning';
        $('sysStats').innerHTML = `<table class="w-full"><tr class="border-b border-slate-700"><td class="text-slate-500 w-32">IP Address</td><td class="font-mono text-white">${escapeHtml(r.data.ip)}</td></tr><tr class="border-b border-slate-700"><td class="text-slate-500">Version</td><td class="text-white">${escapeHtml(r.data.version)}</td></tr><tr><td class="text-slate-500">HA Role</td><td><span class="badge ${badge}">${escapeHtml(role)}</span></td></tr></table>`;
    }

    if (ha.ok && ha.data.hanode) {
        const rows = ha.data.hanode.map((n, i) => {
            const s = (n.state || '').toUpperCase();
            const cls = s.includes('UP') || s.includes('PRIMARY') ? 'badge-success' : 'badge-danger';
            return `<tr class="border-b border-slate-800/50"><td class="text-slate-500">${i + 1}</td><td class="font-mono text-slate-300">${escapeHtml(n.ipaddress || n.ip)}</td><td><span class="badge ${cls}">${s}</span></td><td class="text-slate-500 text-xs">${escapeHtml(n.hasync || '')}</td></tr>`;
        }).join('');
        $('haStatus').innerHTML = `<table><thead><tr><th>#</th><th>IP</th><th>State</th><th>Sync</th></tr></thead><tbody>${rows}</tbody></table>`;
    }
}

async function loadApplications() {
    $('appsTable').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-500">Loading...</td></tr>';
    const mode = state.apiModes[state.node] || 'nitro';
    const endpoint = mode === 'nextgen' ? '/api/applications' : '/api/lb-vservers';
    const r = await getJSON(`${endpoint}?node=${state.node}`);
    
    if (!r.ok) { $('appsTable').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-400">Failed to load</td></tr>'; return; }
    
    const list = (mode === 'nextgen' ? (r.data.applications || []) : (r.data.lbvserver || []));
    const rows = list.length ? list.map((item, i) => {
        const name = item.name || item.vservername || `app-${i}`;
        const vip = item.vip || item.ipv46 || item.ipaddress || '';
        const state = (item.state || item.curstate || '').toUpperCase();
        const badge = (state.includes('UP') || state.includes('ENABLED')) ? 'badge-success' : 'badge-danger';
        return `<tr class="border-b border-slate-800/50 hover:bg-white/5"><td class="text-slate-500 font-mono">${i + 1}</td><td class="text-white font-medium">${escapeHtml(name)}</td><td class="text-blue-300 font-mono text-xs">${escapeHtml(vip)}</td><td class="text-slate-400 font-mono text-xs">${item.port || ''}</td><td><span class="badge ${badge}">${state}</span></td></tr>`;
    }).join('') : '<tr><td colspan="5" class="text-center py-4 text-slate-500">No items found</td></tr>';
    $('appsTable').innerHTML = rows;
}

async function loadServices() {
    $('svcTable').innerHTML = '<tr><td colspan="7" class="text-center py-4 text-slate-500">Loading...</td></tr>';
    const r = await getJSON(`/api/services?node=${state.node}`);
    if (r.ok && r.data.service) {
        const rows = r.data.service.map((s, i) => {
            const st = (s.curstate || '').toUpperCase();
            return `<tr class="border-b border-slate-800/50 hover:bg-white/5"><td class="text-slate-500">${i + 1}</td><td class="text-xs">SVC</td><td class="text-white">${escapeHtml(s.name)}</td><td class="font-mono text-xs text-slate-400">${escapeHtml(s.ip)}</td><td class="text-xs text-slate-300">${s.port}</td><td><span class="badge ${st.includes('UP') ? 'badge-success' : 'badge-danger'}">${st}</span></td><td>-</td></tr>`;
        }).join('');
        $('svcTable').innerHTML = rows || '<tr><td colspan="7" class="text-center text-slate-500 py-4">No services</td></tr>';
    }
}

// --- HISTORY & SESSIONS ---
async function loadFailover() {
    const p = { from: $('failFrom').value, to: $('failTo').value, type: $('failType').value };
    const r = await getJSON(`/api/failover-history?${qs({ ...p, node: state.node })}`);
    const arr = r.ok ? (r.data.events || []) : [];
    const rows = arr.length ? arr.map((e, i) => `<tr><td class="text-slate-500">${i + 1}</td><td>${escapeHtml(new Date(e.timestamp).toLocaleString())}</td><td>${escapeHtml(e.type)}</td><td>${escapeHtml(e.reason)}</td><td>${escapeHtml(e.role_change)}</td></tr>`).join('') : '<tr><td colspan="5" class="text-center py-8 text-slate-500">No events found</td></tr>';
    $('failTable').innerHTML = rows;
}

async function loadSessions() {
    const p = { from: $('sessFrom').value, to: $('sessTo').value, user: $('sessUser').value, type: $('sessType').value, status: $('sessStatus').value };
    const r = await getJSON(`/api/user-sessions?${qs({ ...p, node: state.node })}`);
    const arr = r.ok ? (r.data.sessions || []) : [];
    const rows = arr.length ? arr.map((s, i) => `<tr><td>${i + 1}</td><td>${escapeHtml(s.user)}</td><td>${escapeHtml(s.type)}</td><td>${escapeHtml(s.status)}</td><td>${escapeHtml(s.duration)}</td><td>${escapeHtml(s.ip)}</td><td>${escapeHtml(s.node)}</td><td>${escapeHtml(s.start)}</td></tr>`).join('') : '<tr><td colspan="8" class="text-center py-8 text-slate-500">No sessions found</td></tr>';
    $('sessTable').innerHTML = rows;
}

async function doUnlock() {
    const u = $('unlockUsername').value; if(!u) return;
    $('unlockBtn').textContent = 'Unlocking...';
    $('unlockBtn').disabled = true;
    const r = await getJSON('/api/unlock-user', {method:'POST', body:JSON.stringify({node:$('unlockNode').value, username:u})});
    $('unlockMsg').innerHTML = r.ok && r.data.success ? `<span class="text-green-400">‚úî ${r.data.message}</span>` : `<span class="text-red-400">‚úñ ${r.data.error||'Failed'}</span>`;
    $('unlockBtn').textContent = 'Unlock Account';
    $('unlockBtn').disabled = false;
}

// --- DATE PICKER LOGIC ---
const dp = { el: $('datePicker'), grid: $('dpGrid'), title: $('dpTitle'), hour: $('dpHour'), min: $('dpMin'), target: null, display: null, view: new Date(), selected: null };
dp.el.addEventListener('click', (e) => e.stopPropagation());

(function initTime() {
    for (let h = 0; h < 24; h++) { const o = document.createElement('option'); o.value = h; o.textContent = String(h).padStart(2, '0'); dp.hour.appendChild(o); }
    for (let m = 0; m < 60; m += 5) { const o = document.createElement('option'); o.value = m; o.textContent = String(m).padStart(2, '0'); dp.min.appendChild(o); }
})();

function setInitialDateFields() {
    const now = new Date();
    ['failFrom', 'failTo', 'sessFrom', 'sessTo'].forEach(id => {
        const h = $(id), d = $(id + 'Display');
        if (h && d) { h.value = now.toISOString(); d.value = formatDisplay(now); }
    });
}

function formatDisplay(d) {
    return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
}

function openPicker(hid, did) {
    dp.target = $(hid); dp.display = $(did);
    const now = new Date();
    dp.view = new Date(now.getFullYear(), now.getMonth(), 1);
    
    if (dp.target.value) {
        const d = new Date(dp.target.value);
        if (!isNaN(d)) {
            dp.view = new Date(d.getFullYear(), d.getMonth(), 1);
            dp.selected = new Date(d);
            dp.hour.value = d.getHours();
            dp.min.value = Math.round(d.getMinutes() / 5) * 5 % 60;
        }
    } else {
        dp.selected = new Date();
    }
    renderCalendar();
    
    // Positioning
    const rect = dp.display.getBoundingClientRect();
    dp.el.style.left = Math.min(rect.left + window.scrollX, window.innerWidth - 320) + 'px';
    dp.el.style.top = (rect.bottom + window.scrollY + 6) + 'px';
    dp.el.classList.remove('hidden');
}

function renderCalendar() {
    const y = dp.view.getFullYear(), m = dp.view.getMonth();
    dp.title.textContent = `${dp.view.toLocaleString(undefined, { month: 'long' })} ${y}`;
    dp.grid.innerHTML = '';
    
    ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].forEach(d => {
        const el = document.createElement('div');
        el.className = 'text-slate-500 text-xs font-bold uppercase';
        el.textContent = d;
        dp.grid.appendChild(el);
    });
    
    const first = new Date(y, m, 1);
    for (let i = 0; i < first.getDay(); i++) dp.grid.appendChild(document.createElement('div'));
    
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++) {
        const el = document.createElement('div');
        el.className = 'day p-2 rounded cursor-pointer hover:bg-slate-700 transition-colors text-white';
        el.textContent = d;
        if (dp.selected && d === dp.selected.getDate() && m === dp.selected.getMonth() && y === dp.selected.getFullYear()) {
            el.classList.add('selected'); el.classList.add('bg-blue-600');
        }
        el.addEventListener('click', () => {
            dp.selected = new Date(y, m, d, Number(dp.hour.value), Number(dp.min.value));
            renderCalendar();
        });
        dp.grid.appendChild(el);
    }
}

$('dpPrev').onclick = () => { dp.view.setMonth(dp.view.getMonth() - 1); renderCalendar(); };
$('dpNext').onclick = () => { dp.view.setMonth(dp.view.getMonth() + 1); renderCalendar(); };
$('dpCancel').onclick = () => dp.el.classList.add('hidden');
$('dpApply').onclick = () => {
    if (!dp.selected) dp.selected = new Date();
    dp.selected.setHours(Number(dp.hour.value), Number(dp.min.value));
    dp.target.value = dp.selected.toISOString();
    dp.display.value = formatDisplay(dp.selected);
    dp.el.classList.add('hidden');
};

// Bind pickers
[['failFrom', 'failFromDisplay', 'failFromBtn'], ['failTo', 'failToDisplay', 'failToBtn'],
 ['sessFrom', 'sessFromDisplay', 'sessFromBtn'], ['sessTo', 'sessToDisplay', 'sessToBtn']].forEach(([h, d, b]) => {
    $(d).onclick = () => openPicker(h, d);
    $(b).onclick = () => openPicker(h, d);
});

// Quick ranges
document.querySelectorAll('.dp-quick button').forEach(btn => {
    btn.onclick = () => {
        if (btn.dataset.clear) { dp.target.value = ''; dp.display.value = ''; dp.el.classList.add('hidden'); return; }
        const now = new Date(); let from;
        if (btn.dataset.range === '24h') from = new Date(now - 86400000);
        if (btn.dataset.range === '7d') from = new Date(now - 7 * 86400000);
        if (btn.dataset.range === 'today') from = new Date(now.setHours(0, 0, 0, 0));
        
        if (dp.target.id.endsWith('From')) { dp.target.value = from.toISOString(); dp.display.value = formatDisplay(from); }
        if (dp.target.id.endsWith('To')) { dp.target.value = new Date().toISOString(); dp.display.value = formatDisplay(new Date()); }
        dp.el.classList.add('hidden');
    }
});

document.addEventListener('click', (e) => {
    if (!dp.el.classList.contains('hidden') && !dp.el.contains(e.target) && !e.target.closest('.dp-wrap')) dp.el.classList.add('hidden');
});

// --- INIT ---
function startAutoRefresh() {
    if (state.interval) clearInterval(state.interval);
    state.interval = setInterval(() => {
        const active = document.querySelector('.tab-btn.active').dataset.tab;
        if (active === 'overview') loadOverview();
    }, state.refreshMs);
}

(async function init() {
    setInitialDateFields();
    initCharts();
    await fetchCaps();
    setActiveTab('overview');
})();
</script>
</body>
</html>
