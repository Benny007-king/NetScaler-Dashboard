<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NetScaler Dashboard â€” Dual-Stack (NITRO + Next-Gen)</title>
  <style>
    :root {
      --bg:#0b1220; --panel:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#60a5fa; --success:#34d399; --danger:#f87171; --warn:#fbbf24;
      --border:#1f2937; --chip:#0ea5e9; --input:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
    header{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#0b1220,#0b1220 60%,#0e1729)}
    .brand{display:flex; gap:10px; align-items:center; font-weight:700; letter-spacing:.2px}
    .brand .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);display:inline-block}
    .sub{font-size:12px;color:var(--muted)}
    .controls{display:flex; gap:10px; align-items:center}
    select,button,input{background:var(--input); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px}
    input[readonly]{cursor:pointer}
    button.primary{background:var(--accent); border-color:#2563eb; color:#081225; font-weight:600}
    main{padding:16px}
    .tabs{display:flex; gap:8px; border-bottom:1px solid var(--border)}
    .tab{padding:10px 12px; border:1px solid var(--border); border-bottom:none; border-radius:10px 10px 0 0; background:#0c1426; color:var(--muted); cursor:pointer}
    .tab.active{background:#101a31; color:var(--text); font-weight:600}
    .panel{border:1px solid var(--border); border-top:none; border-radius:0 12px 12px 12px; padding:16px; background:#0c1426; margin-bottom:20px}
    .grid{display:grid; gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .card{background:#0e172a; border:1px solid var(--border); border-radius:12px; padding:12px}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px; border-bottom:1px solid var(--border); text-align:left; font-size:14px}
    th{color:#cbd5e1; font-weight:600}
    .muted{color:var(--muted)}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px; background:#0a1a2a; border:1px solid #12324f; font-size:12px}
    .ok{color:var(--success)} .bad{color:var(--danger)} .warn{color:var(--warn)}
    .hidden{display:none}
    .spacer{height:8px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0b1a2c; border:1px solid #1c314f; padding:2px 6px; border-radius:6px; font-size:12px}

    /* DateRange Picker */
    .dp-input{min-width:220px}
    .dp-wrap{position:relative; display:flex; gap:6px; align-items:center}
    .iconBtn{padding:8px 10px; border-radius:10px}
    .dp{position:fixed; z-index:9999; background:#0c1426; border:1px solid var(--border); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.4); width:320px; padding:10px}
    .dp.hidden{display:none}
    .dp-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
    .dp-header button{padding:6px 10px; border-radius:8px}
    .dp-title{font-weight:600}
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:4px}
    .cal-grid .dow{font-size:12px; color:var(--muted); text-align:center; padding:4px 0}
    .cal-grid .day{padding:6px 0; text-align:center; border-radius:8px; cursor:pointer; user-select:none}
    .day:hover{background:#12203a}
    .day.disabled{opacity:.35; cursor:default}
    .day.selected{background:#1e3a8a}
    .dp-footer{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:10px}
    .dp-footer .time{display:flex; gap:6px; align-items:center}
    .dp-footer select{padding:6px 8px; border-radius:8px}
    .dp-quick{display:flex; gap:6px; margin-top:6px}
    .dp-quick button{padding:4px 8px; border-radius:8px; font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="brand"><span class="dot"></span> NetScaler Dashboard <span class="sub">Dual-Stack</span></div>
  <div class="controls">
    <label class="muted">Node:</label>
    <select id="nodeSelect">
      <option value="primary">primary</option>
      <option value="secondary">secondary</option>
    </select>
    <button id="refreshBtn" class="primary" type="button">Refresh</button>
  </div>
</header>
<main>
  <div class="hint" id="capsLine">Detecting capabilitiesâ€¦</div>
  <div class="tabs" role="tablist">
    <div class="tab active" data-tab="overview" role="tab" aria-selected="true">Overview</div>
    <div class="tab" data-tab="applications" role="tab">Applications</div>
    <div class="tab" data-tab="failover" role="tab">Failover History</div>
    <div class="tab" data-tab="sessions" role="tab">User Sessions</div>
    <div class="tab" data-tab="unlock" role="tab">Unlock Users</div>
  </div>

  <section class="panel" id="panel-overview">
    <div class="grid cols-2">
      <div class="card">
        <h3>System Stats</h3>
        <div id="sysStats" class="muted">Loadingâ€¦</div>
      </div>
      <div class="card">
        <h3>HA Status</h3>
        <div id="haStatus" class="muted">Loadingâ€¦</div>
      </div>
    </div>
  </section>

  <section class="panel hidden" id="panel-applications">
    <div class="spacer"></div>
    <div id="appsNotice" class="hint muted"></div>
    <div class="spacer"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px">
        <h3 style="margin:0">Applications</h3>
        <div class="chip" id="appsModeChip">mode: <span id="appsMode">â€¦</span></div>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:32px">#</th>
            <th>Name</th>
            <th>VIP</th>
            <th>Port</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="appsTable"><tr><td class="muted" colspan="5">Loadingâ€¦</td></tr></tbody>
      </table>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Services &amp; Service Groups</h3>
      <table>
        <thead>
          <tr>
            <th style="width:32px">#</th>
            <th>Type</th>
            <th>Name</th>
            <th>IP / Server</th>
            <th>Port</th>
            <th>Status</th>
            <th>Members</th>
          </tr>
        </thead>
        <tbody id="svcTable"><tr><td class="muted" colspan="7">Loadingâ€¦</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class="panel hidden" id="panel-failover">
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <strong>Filters:</strong>
        <label class="muted">From</label>
        <div class="dp-wrap">
          <input id="failFrom" type="hidden" />
          <input id="failFromDisplay" class="dp-input" type="text" placeholder="dd/mm/yyyy hh:mm" readonly />
          <button class="iconBtn" id="failFromBtn" title="Pick date" type="button">ðŸ“…</button>
        </div>
        <label class="muted">To</label>
        <div class="dp-wrap">
          <input id="failTo" type="hidden" />
          <input id="failToDisplay" class="dp-input" type="text" placeholder="dd/mm/yyyy hh:mm" readonly />
          <button class="iconBtn" id="failToBtn" title="Pick date" type="button">ðŸ“…</button>
        </div>
        <label class="muted">Type</label>
        <select id="failType">
          <option value="">All</option>
          <option value="automatic">Automatic</option>
          <option value="manual">Manual</option>
          <option value="failure">Failure</option>
          <option value="role-change">Role change</option>
        </select>
        <button id="failSearch" class="primary" type="button">Search</button>
        <button id="failExport" type="button">Export CSV</button>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:32px">#</th>
            <th>Timestamp</th>
            <th>Event Type</th>
            <th>Reason</th>
            <th>Role Change</th>
          </tr>
        </thead>
        <tbody id="failTable"><tr><td class="muted" colspan="5">Set filters and click Searchâ€¦</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class="panel hidden" id="panel-sessions">
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <strong>Filters:</strong>
        <label class="muted">From</label>
        <div class="dp-wrap">
          <input id="sessFrom" type="hidden" />
          <input id="sessFromDisplay" class="dp-input" type="text" placeholder="dd/mm/yyyy hh:mm" readonly />
          <button class="iconBtn" id="sessFromBtn" title="Pick date" type="button">ðŸ“…</button>
        </div>
        <label class="muted">To</label>
        <div class="dp-wrap">
          <input id="sessTo" type="hidden" />
          <input id="sessToDisplay" class="dp-input" type="text" placeholder="dd/mm/yyyy hh:mm" readonly />
          <button class="iconBtn" id="sessToBtn" title="Pick date" type="button">ðŸ“…</button>
        </div>
        <label class="muted">User</label>
        <input id="sessUser" type="text" placeholder="user@domain" />
        <label class="muted">Type</label>
        <select id="sessType">
          <option value="">All</option>
          <option value="web">Web</option>
          <option value="vpn">VPN</option>
          <option value="workspace">Workspace</option>
        </select>
        <label class="muted">Status</label>
        <select id="sessStatus">
          <option value="">All</option>
          <option value="active">Active</option>
          <option value="terminated">Terminated</option>
        </select>
        <button id="sessSearch" class="primary" type="button">Search</button>
        <button id="sessExport" type="button">Export CSV</button>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:32px">#</th>
            <th>User</th>
            <th>Type</th>
            <th>Status</th>
            <th>Duration</th>
            <th>Client IP</th>
            <th>Node</th>
            <th>Start Time</th>
          </tr>
        </thead>
        <tbody id="sessTable"><tr><td class="muted" colspan="8">Set filters and click Searchâ€¦</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class="panel hidden" id="panel-unlock">
    <div class="card">
      <h3>Unlock AAA User</h3>
      <div class="row" style="margin-bottom:10px">
        <label class="muted">Node</label>
        <select id="unlockNode">
          <option value="primary">primary</option>
          <option value="secondary">secondary</option>
        </select>
        <label class="muted">Username</label>
        <input id="unlockUsername" type="text" placeholder="user1" />
        <button id="unlockBtn" class="primary" type="button">Unlock</button>
      </div>
      <div id="unlockMsg" class="muted" style="min-height:20px"></div>
      <div class="hint">Note: operation uses NITRO <code>/nitro/v1/config/aaauser</code> with automatic fallback to <code>?action=unlock</code>.</div>
    </div>
  </section>
</main>

<!-- Date Picker Popover -->
<div id="datePicker" class="dp hidden" role="dialog" aria-modal="true">
  <div class="dp-header">
    <button id="dpPrev" title="Prev month" type="button">â€¹</button>
    <div class="dp-title" id="dpTitle">Month YYYY</div>
    <button id="dpNext" title="Next month" type="button">â€º</button>
  </div>
  <div class="cal-grid" id="dpGrid"></div>
  <div class="dp-quick">
    <button data-range="24h" type="button">Last 24h</button>
    <button data-range="7d" type="button">Last 7d</button>
    <button data-range="today" type="button">Today</button>
    <button data-clear="1" type="button">Clear</button>
  </div>
  <div class="dp-footer">
    <div class="time">
      <span class="muted">Time</span>
      <select id="dpHour"></select>:<select id="dpMin"></select>
    </div>
    <div>
      <button id="dpCancel" type="button">Cancel</button>
      <button id="dpApply" class="primary" type="button">Apply</button>
    </div>
  </div>
</div>

<script>
const state = {
  node: 'primary',
  apiModes: {},
  interval: null,
  refreshMs: 30000
};

function $(sel){return document.querySelector(sel)}
function $all(sel){return Array.from(document.querySelectorAll(sel))}

/* ---------- helpers ---------- */
async function getJSON(url, opts){
  const res = await fetch(url, {headers:{'Accept':'application/json'}, ...(opts||{})});
  const text = await res.text();
  try { return {ok: res.ok, status: res.status, data: text? JSON.parse(text): {}}; }
  catch(e){ return {ok: res.ok, status: res.status, data: {raw:text}}; }
}
function qs(params){
  const esc = encodeURIComponent;
  return Object.entries(params)
    .filter(([_,v])=> v!==undefined && v!==null && v!=='')
    .map(([k,v])=>`${esc(k)}=${esc(v)}`)
    .join('&');
}
function fmt(v){ if(!v) return ''; try{ return new Date(v).toLocaleString(); }catch(e){ return String(v); } }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

/* ---------- tabs + caps ---------- */
function setActiveTab(name){
  $all('.tab').forEach(t=>{
    const active = t.dataset.tab===name;
    t.classList.toggle('active', active);
    t.setAttribute('aria-selected', active?'true':'false');
  });
  $all('section.panel').forEach(p=>p.classList.add('hidden'));
  document.getElementById(`panel-${name}`).classList.remove('hidden');
  if(name==='overview') loadOverview();
  if(name==='applications') { loadApplications(); loadServices(); }
  if(name==='failover') loadFailover();
  if(name==='sessions') loadSessions();
  if(name==='unlock') loadUnlock();
}

async function fetchCaps(){
  const r = await getJSON('/api/caps');
  if(!r.ok){ $('#capsLine').textContent = 'Capabilities: unavailable'; return; }
  state.apiModes = r.data.api_mode || {};
  const p = state.apiModes.primary || 'nitro';
  const s = state.apiModes.secondary || 'nitro';
  $('#capsLine').innerHTML = `Capabilities â€” primary: <span class="kbd">${p}</span>, secondary: <span class="kbd">${s}</span>`;
  updateAppsTabAvailability();
}
function updateAppsTabAvailability(){
  const mode = state.apiModes[state.node] || 'nitro';
  const note = $('#appsNotice');
  const chip = $('#appsMode');
  if (chip) chip.textContent = mode;
  if (note) {
    note.textContent = (mode === 'nextgen')
      ? ''
      : 'Nitro mode â€” showing LB vservers as Applications (fallback).';
  }
}

/* ---------- Overview ---------- */
async function loadOverview(){
  const [statsAll, haAll] = await Promise.all([
    getJSON('/api/system-stats'),
    getJSON('/api/ha-status')
  ]);
  const get = (obj, keys, def='')=>{
    for(const k of keys){ if(obj && obj[k]!==undefined && obj[k]!==null) return obj[k]; }
    return def;
  };
  const num = v=> (v===undefined||v===null||v==='')? '': (typeof v==='number'? v: Number(v));

  if(statsAll.ok && (statsAll.data.primary || statsAll.data.secondary)){
    const rows = ['primary','secondary'].map(node=>{
      const d = statsAll.data[node] || {};
      const ns = d.ns_stats?.ns || d.ns_stats || {};
      const cpu = get(ns, ['cpuusagepcnt','cpuusage','cpu_usage','cpuusagepct','cpuusage_pc'] , '');
      const mem = get(ns, ['memusagepcnt','memoryusagepcnt','memusagepct'], '');
      const httpRate = get(ns, ['httprequestsrate','httprequestrate','http_requests_rate','httprequests_rate'], '');
      const ver = d.version || '';
      const role = d.ha_role || '';
      const ip = d.ip || '';
      return `<tr>
        <td class="muted">${node}</td>
        <td>${escapeHtml(ip+'')}</td>
        <td>${escapeHtml(role+'')}</td>
        <td>${escapeHtml(ver+'')}</td>
        <td>${cpu!==''? escapeHtml(num(cpu).toFixed(1)+'%'): ''}</td>
        <td>${mem!==''? escapeHtml(num(mem).toFixed(1)+'%'): ''}</td>
        <td>${httpRate!==''? escapeHtml(num(httpRate).toFixed(0)): ''}</td>
      </tr>`;
    }).join('');

    $('#sysStats').innerHTML = `<table><thead><tr>
      <th>Node</th><th>IP</th><th>Role</th><th>Version</th><th>CPU</th><th>Mem</th><th>HTTP req/s</th>
    </tr></thead><tbody>${rows}</tbody></table>`;
  } else {
    const node = state.node;
    const single = await getJSON(`/api/system-stats?node=${encodeURIComponent(node)}`);
    $('#sysStats').textContent = single.ok ? JSON.stringify(single.data.ns_stats || single.data.stats || single.data, null, 2) : 'Error loading stats';
  }

  if(haAll.ok && (haAll.data.hanode || (haAll.data.primary && haAll.data.secondary))){
    const items = Array.isArray(haAll.data.hanode)? haAll.data.hanode: [];
    if(items.length){
      const rows = items.map((n,i)=>{
        const name = n.name || `node-${i+1}`;
        const ip = n.ipaddress || n.ip || '';
        const theState = n.state || n.hastatus || '';
        const hasync = n.hasync || n.syncstatusstrictmode || '';
        const rm = n.routemonitorstate || '';
        const cls = /UP|PRIMARY|SUCCESS/i.test(theState)? 'ok' : /DOWN|FAIL/i.test(theState)? 'bad' : 'warn';
        return `<tr>
          <td class="muted">${i+1}</td>
          <td>${escapeHtml(name+'')}</td>
          <td>${escapeHtml(ip+'')}</td>
          <td><span class="${cls}">${escapeHtml(String(theState))}</span></td>
          <td>${escapeHtml(String(hasync))}</td>
          <td>${escapeHtml(String(rm))}</td>
        </tr>`;
      }).join('');
      $('#haStatus').innerHTML = `<table><thead><tr>
        <th>#</th><th>Name</th><th>IP</th><th>Status</th><th>HA Sync</th><th>Route Monitor</th>
      </tr></thead><tbody>${rows}</tbody></table>`;
    } else {
      $('#haStatus').textContent = 'No HA data';
    }
  } else {
    const node = state.node;
    const single = await getJSON(`/api/ha-status?node=${encodeURIComponent(node)}`);
    $('#haStatus').textContent = single.ok ? JSON.stringify(single.data.hanode || single.data, null, 2) : 'Error loading HA status';
  }
}

/* ---------- Applications / Services ---------- */
async function loadApplications(){
  const mode = state.apiModes[state.node] || 'nitro';
  const chipEl = $('#appsMode'); if (chipEl) chipEl.textContent = mode;

  if(mode === 'nextgen'){
    const r = await getJSON(`/api/applications?node=${encodeURIComponent(state.node)}`);
    if(!r.ok){
      const msg = r.status===501? 'Next-Gen API not enabled for this node' : 'Failed to load applications';
      $('#appsTable').innerHTML = `<tr><td colspan="5" class="muted">${msg}</td></tr>`;
      return;
    }
    let items = [];
    const d = r.data.applications ?? r.data ?? [];
    if(Array.isArray(d)) items = d; else if (typeof d === 'object'){
      if(Array.isArray(d.applications)) items = d.applications; else {
        for(const k in d){ if(Array.isArray(d[k])) items = items.concat(d[k]); }
      }
    }
    if(!items.length){
      $('#appsTable').innerHTML = `<tr><td colspan="5" class="muted">No applications found</td></tr>`;
      return;
    }
    const rows = items.map((a,i)=>{
      const name = a?.name ?? a?.appName ?? `app-${i+1}`;
      const vip  = a?.vip ?? a?.vipAddress ?? a?.listener?.vip ?? '';
      const port = a?.port ?? a?.listener?.port ?? '';
      const state = (a?.state ?? a?.status ?? 'UP').toString().toUpperCase();
      const cls = state.includes('UP')? 'ok' : state.includes('DOWN')? 'bad' : 'warn';
      return `<tr>
        <td class="muted">${i+1}</td>
        <td>${escapeHtml(name)}</td>
        <td>${escapeHtml(String(vip))}</td>
        <td>${escapeHtml(String(port))}</td>
        <td><span class="${cls}">${escapeHtml(state)}</span></td>
      </tr>`;
    }).join('');
    $('#appsTable').innerHTML = rows;
    return;
  }

  const r = await getJSON(`/api/lb-vservers?node=${encodeURIComponent(state.node)}`);
  if(!r.ok){
    $('#appsTable').innerHTML = `<tr><td colspan="5" class="muted">Failed to load LB vservers (HTTP ${r.status})</td></tr>`;
    return;
  }
  const list = r.data?.lbvserver || r.lbvserver || [];
  if(!Array.isArray(list) || !list.length){
    $('#appsTable').innerHTML = `<tr><td colspan="5" class="muted">No LB vservers</td></tr>`;
    return;
  }
  const rows = list.map((v,i)=>{
    const name  = v.name || v.vservername || `lbv-${i+1}`;
    const vip   = v.ipv46 || v.ipaddress || v.ip || '';
    const port  = v.port || v.portno || '';
    const state = (v.curstate || v.state || '').toString().toUpperCase();
    const cls   = /UP|ENABLED/.test(state) ? 'ok' : /DOWN|DISABLED/.test(state) ? 'bad' : 'warn';
    return `<tr>
      <td class="muted">${i+1}</td>
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(String(vip))}</td>
      <td>${escapeHtml(String(port))}</td>
      <td><span class="${cls}">${escapeHtml(state)}</span></td>
    </tr>`;
  }).join('');
  $('#appsTable').innerHTML = rows;
}

async function loadServices(){
  const r = await getJSON(`/api/services?node=${encodeURIComponent(state.node)}`);
  if(!r.ok){
    $('#svcTable').innerHTML = `<tr><td colspan="7" class="muted">Failed to load services (HTTP ${r.status})</td></tr>`;
    return;
  }
  const services = Array.isArray(r.data.service) ? r.data.service : [];
  const groups   = Array.isArray(r.data.servicegroup) ? r.data.servicegroup : [];
  if(!services.length && !groups.length){
    $('#svcTable').innerHTML = `<tr><td colspan="7" class="muted">No services or groups</td></tr>`;
    return;
  }
  const rowsSvc = services.map((s,i)=> {
    const name  = s.name || s.servicename || `svc-${i+1}`;
    const ip    = s.ip || s.ipaddress || s.svrip || '';
    const port  = s.port || s.portno || '';
    const state = (s.curstate || s.state || '').toString().toUpperCase();
    const cls   = /UP|ENABLED/.test(state) ? 'ok' : /DOWN|DISABLED/.test(state) ? 'bad' : 'warn';
    return `<tr>
      <td class="muted">${i+1}</td>
      <td>service</td>
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(String(ip))}</td>
      <td>${escapeHtml(String(port))}</td>
      <td><span class="${cls}">${escapeHtml(state)}</span></td>
      <td></td>
    </tr>`;
  });

  const rowsGrp = groups.map((g,i)=>{
    const name  = g.servicegroupname || g.name || `svcgrp-${i+1}`;
    const port  = g.port || g.portno || '';
    const state = (g.curstate || g.state || '').toString().toUpperCase();
    const mem   = Array.isArray(g.members)? g.members.length : (g.membercount || '');
    const cls   = /UP|ENABLED/.test(state) ? 'ok' : /DOWN|DISABLED/.test(state) ? 'bad' : 'warn';
    return `<tr>
      <td class="muted">${services.length + i + 1}</td>
      <td>servicegroup</td>
      <td>${escapeHtml(name)}</td>
      <td></td>
      <td>${escapeHtml(String(port))}</td>
      <td><span class="${cls}">${escapeHtml(state)}</span></td>
      <td>${escapeHtml(String(mem||''))}</td>
    </tr>`;
  });

  $('#svcTable').innerHTML = rowsSvc.concat(rowsGrp).join('');
}

/* ---------- Failover ---------- */
function collectFailoverFilters(){
  return {
    from: $('#failFrom').value || '',
    to:   $('#failTo').value   || '',
    type: $('#failType').value
  };
}
async function loadFailover(){
  const node = state.node;
  const p = collectFailoverFilters();
  const url = `/api/failover-history?${qs({...p, node})}`;
  const r = await getJSON(url);
  if(!r.ok){
    $('#failTable').innerHTML = `<tr><td colspan="5" class="muted">Failed to load failover history (HTTP ${r.status})</td></tr>`;
    return;
  }
  const arr = (r.data.events || r.data.failover || r.data.failover_history || []);
  if(!Array.isArray(arr) || !arr.length){
    $('#failTable').innerHTML = `<tr><td colspan="5" class="muted">No events</td></tr>`;
    return;
  }
  const rows = arr.map((e,i)=>{
    const ts = (e.timestamp || e.time || e.occurred_at || e.when);
    const typ = (e.type || e.eventType || '').toString();
    const reason = (e.reason || e.cause || '').toString();
    const role = (e.role_change || (e.from && e.to ? `${e.from} â†’ ${e.to}` : '')).toString();
    return `<tr>
      <td class="muted">${i+1}</td>
      <td>${escapeHtml(new Date(ts).toLocaleString())}</td>
      <td>${escapeHtml(typ)}</td>
      <td>${escapeHtml(reason)}</td>
      <td>${escapeHtml(role)}</td>
    </tr>`
  }).join('');
  $('#failTable').innerHTML = rows;
}

/* ---------- Sessions (placeholder) ---------- */
function collectSessionFilters(){
  return {
    from: $('#sessFrom').value || '',
    to:   $('#sessTo').value   || '',
    user: $('#sessUser').value.trim(),
    type: $('#sessType').value,
    status: $('#sessStatus').value
  };
}
async function loadSessions(){
  const node = state.node;
  const p = collectSessionFilters();
  const url = `/api/user-sessions?${qs({...p, node})}`;
  const r = await getJSON(url);
  if(!r.ok){
    $('#sessTable').innerHTML = `<tr><td colspan="8" class="muted">Failed to load sessions (HTTP ${r.status})</td></tr>`;
    return;
  }
  const arr = (r.data.sessions || r.data.items || r.data || []);
  const list = Array.isArray(arr) ? arr : [];
  if(!list.length){
    $('#sessTable').innerHTML = `<tr><td colspan="8" class="muted">No sessions</td></tr>`;
    return;
  }
  const rows = list.map((s,i)=>{
    const user = s.user || s.username || s.cn || '';
    const type = s.type || s.protocol || s.kind || '';
    const status = (s.status || s.state || '').toString();
    const dur = s.duration || s.elapsed || '';
    const ip = s.client_ip || s.ip || s.src || '';
    const nodeName = s.node || s.device || '';
    const start = (s.start_time || s.started_at || s.login_time || '');
    const cls = /active|up/i.test(status)? 'ok' : /term|down|fail/i.test(status)? 'bad' : 'warn';
    return `<tr>
      <td class="muted">${i+1}</td>
      <td>${escapeHtml(user+'')}</td>
      <td>${escapeHtml(type+'')}</td>
      <td><span class="${cls}">${escapeHtml(status+'')}</span></td>
      <td>${escapeHtml((dur+'')||'')}</td>
      <td>${escapeHtml(ip+'')}</td>
      <td>${escapeHtml(nodeName+'')}</td>
      <td>${escapeHtml(new Date(start).toLocaleString())}</td>
    </tr>`
  }).join('');
  $('#sessTable').innerHTML = rows;
}

/* ---------- Date Picker logic ---------- */
const dp = {
  el: $('#datePicker'),
  grid: $('#dpGrid'),
  title: $('#dpTitle'),
  hour: $('#dpHour'),
  min: $('#dpMin'),
  target: null,
  display: null,
  view: new Date(),
  selected: null
};
dp.el.addEventListener('click', (e)=> e.stopPropagation()); // prevent auto-close on inner clicks

// init hour/min options
(function initTime(){
  for(let h=0; h<24; h++){ const o=document.createElement('option'); o.value=h; o.textContent=String(h).padStart(2,'0'); dp.hour.appendChild(o); }
  for(let m=0; m<60; m+=5){ const o=document.createElement('option'); o.value=m; o.textContent=String(m).padStart(2,'0'); dp.min.appendChild(o); }
})();

function formatDisplay(d){
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0');
  const min=String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
}
function setPair(hiddenId, displayId, dateObj){
  const hid = document.getElementById(hiddenId);
  const dsp = document.getElementById(displayId);
  if(!hid || !dsp) return;
  hid.value  = dateObj.toISOString();
  dsp.value  = formatDisplay(dateObj);
}
function setInitialDateFields(){
  const now  = new Date(); // ×‘×¨×™×¨×ª ×ž×—×“×œ: NOW ×œ×©× ×™ ×”×©×“×•×ª
  setPair('failFrom','failFromDisplay', now);
  setPair('failTo',  'failToDisplay',   now);
  setPair('sessFrom','sessFromDisplay', now);
  setPair('sessTo',  'sessToDisplay',   now);
}

function openPicker(hiddenId, displayId){
  dp.target = document.getElementById(hiddenId);
  dp.display = document.getElementById(displayId);

  const now = new Date();
  dp.view = new Date(now.getFullYear(), now.getMonth(), 1);
  const existingISO = dp.target.value;
  if(existingISO){
    const d = new Date(existingISO);
    if(!isNaN(d)) {
      dp.view = new Date(d.getFullYear(), d.getMonth(), 1);
      dp.selected = new Date(d);
      dp.hour.value = d.getHours();
      dp.min.value  = Math.round(d.getMinutes()/5)*5 % 60;
    }
  } else {
    dp.selected = new Date();
    dp.hour.value = dp.selected.getHours();
    dp.min.value  = Math.round(dp.selected.getMinutes()/5)*5 % 60;
  }
  renderCalendar();

  const rect = dp.display.getBoundingClientRect();
  dp.el.style.left = Math.min(rect.left, window.innerWidth - 340) + 'px';
  dp.el.style.top  = (rect.bottom + 6) + 'px';
  dp.el.classList.remove('hidden');
}
function closePicker(){ dp.el.classList.add('hidden'); dp.target = null; dp.display = null; }

function renderCalendar(){
  const y = dp.view.getFullYear(), m = dp.view.getMonth();
  dp.title.textContent = `${dp.view.toLocaleString(undefined,{month:'long'})} ${y}`;

  dp.grid.innerHTML = '';
  const dows = ['Su','Mo','Tu','We','Th','Fr','Sa'];
  dows.forEach(d => {
    const el = document.createElement('div');
    el.className='dow';
    el.textContent=d;
    dp.grid.appendChild(el);
  });

  const first = new Date(y, m, 1);
  const startDow = first.getDay();
  const daysInMonth = new Date(y, m+1, 0).getDate();

  for(let i=0;i<startDow;i++){
    const b = document.createElement('div'); b.className='day disabled'; b.textContent=''; dp.grid.appendChild(b);
  }
  for(let d=1; d<=daysInMonth; d++){
    const el = document.createElement('div');
    el.className = 'day';
    el.textContent = d;
    const candidate = new Date(y, m, d);
    if(dp.selected && candidate.toDateString() === dp.selected.toDateString()) el.classList.add('selected');
    el.addEventListener('click', ()=>{
      dp.selected = new Date(y, m, d, Number(dp.hour.value), Number(dp.min.value));
      renderCalendar(); // keep open until Apply
    });
    dp.grid.appendChild(el);
  }
}

$('#dpPrev').addEventListener('click', ()=>{ dp.view = new Date(dp.view.getFullYear(), dp.view.getMonth()-1, 1); renderCalendar(); });
$('#dpNext').addEventListener('click', ()=>{ dp.view = new Date(dp.view.getFullYear(), dp.view.getMonth()+1, 1); renderCalendar(); });
$('#dpCancel').addEventListener('click', closePicker);
$('#dpApply').addEventListener('click', ()=>{
  if(!dp.selected){ dp.selected = new Date(dp.view.getFullYear(), dp.view.getMonth(), 1, Number(dp.hour.value), Number(dp.min.value)); }
  dp.selected.setHours(Number(dp.hour.value), Number(dp.min.value), 0, 0);
  dp.target.value  = dp.selected.toISOString();
  dp.display.value = formatDisplay(dp.selected);
  closePicker();
});

// Quick ranges
$all('.dp-quick button').forEach(btn=>{
  if(btn.dataset.clear){ btn.addEventListener('click', ()=>{ if(!dp.target) return; dp.target.value=''; dp.display.value=''; closePicker(); }); return; }
  btn.addEventListener('click', ()=>{
    const now = new Date();
    let from;
    if(btn.dataset.range==='24h'){ from = new Date(now.getTime()-24*3600*1000); }
    else if(btn.dataset.range==='7d'){ from = new Date(now.getTime()-7*24*3600*1000); }
    else if(btn.dataset.range==='today'){ from = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0); }
    if(!dp.target) return;
    if(dp.target.id.endsWith('From')){
      dp.target.value = from.toISOString();
      dp.display.value = formatDisplay(from);
    } else if(dp.target.id.endsWith('To')){
      dp.target.value = now.toISOString();
      dp.display.value = formatDisplay(now);
    }
    closePicker();
  });
});

// openers
[['failFrom','failFromDisplay','failFromBtn'],
 ['failTo','failToDisplay','failToBtn'],
 ['sessFrom','sessFromDisplay','sessFromBtn'],
 ['sessTo','sessToDisplay','sessToBtn']].forEach(([hid,disp,btn])=>{
  const open = ()=>openPicker(hid, disp);
  document.getElementById(disp)?.addEventListener('click', open);
  document.getElementById(btn)?.addEventListener('click', open);
});

// close on outside click / ESC
document.addEventListener('click', (e)=>{
  if(dp.el.classList.contains('hidden')) return;
  if(!dp.el.contains(e.target) && e.target!==dp.display){ closePicker(); }
});
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePicker(); });

/* ---------- Unlock ---------- */
function loadUnlock(){
  const sel = $('#unlockNode'); if(sel) sel.value = state.node;
  const msg = $('#unlockMsg'); if(msg) msg.textContent='';
  const input = $('#unlockUsername');
  if(input && !input._bound){
    input.addEventListener('keyup', (e)=>{ if(e.key==='Enter') doUnlock(); });
    input._bound = true;
  }
  const btn = $('#unlockBtn');
  if(btn && !btn._bound){
    btn.addEventListener('click', doUnlock);
    btn._bound = true;
  }
}
async function doUnlock(){
  const node = $('#unlockNode').value || state.node;
  const username = ($('#unlockUsername').value || '').trim();
  const btn = $('#unlockBtn');
  const msg = $('#unlockMsg');
  msg.textContent = '';
  if(!username){ msg.textContent='Please enter a username.'; return; }
  btn.disabled = true; const old = btn.textContent; btn.textContent = 'Workingâ€¦';
  try{
    const r = await getJSON('/api/unlock-user', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({node, username})
    });
    if(r.ok && r.data.success){
      msg.innerHTML = `<span class="ok">âœ” ${r.data.message}</span>`;
      $('#unlockUsername').value = '';
    }else{
      const err = r.data?.error || `Failed (HTTP ${r.status})`;
      msg.innerHTML = `<span class="bad">âœ– ${escapeHtml(err)}</span>`;
    }
  }catch(e){
    msg.innerHTML = `<span class="bad">âœ– ${escapeHtml(String(e))}</span>`;
  }finally{
    btn.disabled = false; btn.textContent = old;
  }
}

/* ---------- glue ---------- */
function startAutoRefresh(){
  if(state.interval) clearInterval(state.interval);
  state.interval = setInterval(()=>{
    const active = document.querySelector('.tab.active')?.dataset.tab;
    if(active==='overview') loadOverview();
    if(active==='applications') { loadApplications(); loadServices(); }
    if(active==='failover') loadFailover();
    if(active==='sessions') loadSessions();
  }, state.refreshMs);
}

document.getElementById('nodeSelect')?.addEventListener('change', (e)=>{
  state.node = e.target.value;
  updateAppsTabAvailability();
  const active = document.querySelector('.tab.active')?.dataset.tab;
  if(active==='overview') loadOverview();
  if(active==='applications') { loadApplications(); loadServices(); }
  if(active==='failover') loadFailover();
  if(active==='sessions') loadSessions();
  if(active==='unlock') loadUnlock();
});
document.getElementById('refreshBtn')?.addEventListener('click', ()=>{
  fetchCaps();
  const active = document.querySelector('.tab.active')?.dataset.tab;
  if(active==='overview') loadOverview();
  if(active==='applications') { loadApplications(); loadServices(); }
  if(active==='failover') loadFailover();
  if(active==='sessions') loadSessions();
});

$all('.tab').forEach(t=> t.addEventListener('click', ()=> setActiveTab(t.dataset.tab)));
document.getElementById('failSearch')?.addEventListener('click', loadFailover);
document.getElementById('sessSearch')?.addEventListener('click', loadSessions);
document.getElementById('failExport')?.addEventListener('click', ()=>window.open(`/api/export/failover-history`,'_blank'));
document.getElementById('sessExport')?.addEventListener('click', ()=>window.open(`/api/export/user-sessions`,'_blank'));

// Init
(async function init(){
  setInitialDateFields();     // default: NOW for both fields
  await fetchCaps();
  setActiveTab('overview');
  startAutoRefresh();
})();
</script>
</body>
</html>
